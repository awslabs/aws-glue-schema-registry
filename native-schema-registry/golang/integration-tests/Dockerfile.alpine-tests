FROM golang:tip-bullseye


# Set Go environment
ENV GOPATH=/go
ENV PATH=$GOPATH/bin:/usr/local/go/bin:$PATH
ENV CGO_ENABLED=1
ENV GOPROXY=direct
ENV GOSUMDB=sum.golang.org


# Create app directory structure
WORKDIR /app

# Copy only the golang directory
COPY golang/ ./golang/

# Set up module dependencies - start with parent golang module
WORKDIR /app/golang
RUN go mod download

# Now set up integration-tests module
WORKDIR /app/golang/integration-tests
RUN go mod download

# Copy and make helper script executable
RUN chmod +x ./scripts/run-tests-alpine.sh
RUN cp ./scripts/run-tests-alpine.sh /usr/local/bin/run-tests-alpine.sh
# Install necessary dependencies for AWS CLI (e.g., unzip)
RUN apt-get update && apt-get install -y unzip && rm -rf /var/lib/apt/lists/*

RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
RUN unzip awscliv2.zip
RUN ./aws/install
# Default command
CMD ["run-tests-alpine.sh"]
